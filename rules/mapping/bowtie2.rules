rule bowtie2_index:
    input:
        "references/{reference}.fna.gz"
    output:
        expand("mapping/bowtie2/{{reference}}.{index}.bt2", index=range(1,5)),
        expand("mapping/bowtie2/{{reference}}.rev.{index}.bt2", index=range(1,3))
    params:
        prefix="mapping/bowtie2/{reference}"
    shell:
        "bowtie2-build {input} {params.prefix}"

rule bowtie2_map:
    input:
        "samples/{sample}.fastq",
        expand("mapping/bowtie2/{{reference}}.{index}.bt2", index=range(1,5)),
        expand("mapping/bowtie2/{{reference}}.rev.{index}.bt2", index=range(1,3))
        #references = rules.bowtie2_index.output
    output:
        "mapping/bowtie2/{reference}/{sample}/{sample}.bam"
    params:
        ref_idx_base="mapping/bowtie2/{reference}"
    shell:
        "{config[bowtie2_rules][load_env]}
        bowtie2 
        -x {params.ref_idx_base} \
        -p {threads} {params.read_input_str} \
        -S {params.sam} \
        2> {log} && \
        samtools view -Sbh {params.sam} > {output} && \
        rm {params.sam}"
